apiVersion: v1
kind: Namespace
metadata:
  name: wireguard
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: wireguard
  namespace: flux-system
spec:
  interval: 24h
  url: https://bryopsida.github.io/wireguard-chart
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: wireguard
  namespace: wireguard
spec:
  interval: 30m
  chart: 
    spec:
      chart: wireguard
      version: '>=0.0.0'
      sourceRef:
        kind: HelmRepository
        name: wireguard
        namespace: flux-system
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    service:
      type: LoadBalancer
      loadBalancerIP: 10.0.50.204  # Pick an IP from your MetalLB pool
      port: 51820
    
    wireguard:
      serverAddress: 10.34.0.1/24
      serverCidr: 10.34.0.0/24
      allowWan: true  # true because we're doing split-tunnel (not routing all traffic)
      
      # DNS servers in your priority order (WireGuard passes all to client OS)
      # Client configs will get: DNS = 10.0.50.203, 10.0.10.22, 10.0.10.64
      interfaceOpts:
        DNS: "10.0.50.203, 10.0.10.22, 10.0.10.64"
      
      # Example clients - generate keys and add them here, or use the WireGuard UI
      # For split-tunnel to your local networks, set AllowedIPs to those subnets only
      clients: []
        # - FriendlyName: my-phone
        #   PublicKey: <client-public-key>
        #   AllowedIPs: 10.0.10.0/24, 10.0.50.0/24  # Split-tunnel: only route these subnets
    
    # Enable metrics/monitoring
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true

