apiVersion: v1
kind: Namespace
metadata:
  name: openwifi
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: openwifi
  namespace: flux-system
spec:
  interval: 24h
  url: https://tip.jfrog.io/artifactory/tip-wlan-cloud-ucentral-helm/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openwifi
  namespace: openwifi
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: openwifi
      version: ">=0.1.0"
      sourceRef:
        kind: HelmRepository
        name: openwifi
        namespace: flux-system
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  # Mount TLS certs from existing secret
  valuesFrom:
    # owgw certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: websocket-cert.pem
      targetPath: owgw.certs.websocket-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: websocket-key.pem
      targetPath: owgw.certs.websocket-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owgw.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owgw.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owgw.certs.restapi-ca\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: issuer.pem
      targetPath: owgw.certs.issuer\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: root.pem
      targetPath: owgw.certs.root\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: clientcas.pem
      targetPath: owgw.certs.clientcas\.pem
    # owsec certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owsec.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owsec.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owsec.certs.restapi-ca\.pem
    # owfms certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owfms.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owfms.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owfms.certs.restapi-ca\.pem
    # owprov certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owprov.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owprov.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owprov.certs.restapi-ca\.pem
    # owanalytics certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owanalytics.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owanalytics.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owanalytics.certs.restapi-ca\.pem
    # owsub certs
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-cert.pem
      targetPath: owsub.certs.restapi-cert\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-key.pem
      targetPath: owsub.certs.restapi-key\.pem
    - kind: Secret
      name: openwifi-certs
      valuesKey: restapi-ca.pem
      targetPath: owsub.certs.restapi-ca\.pem
    # S3 credentials for firmware database
    - kind: Secret
      name: owfms-s3-credentials
      valuesKey: s3-key
      targetPath: owfms.configProperties.s3\.key
    - kind: Secret
      name: owfms-s3-credentials
      valuesKey: s3-secret
      targetPath: owfms.configProperties.s3\.secret
  values:
    # ─── Kafka (bitnami subchart) ────────────────────────────────
    kafka:
      enabled: true
      fullnameOverride: kafka
      image:
        repository: bitnamilegacy/kafka
      # Disable SASL — OpenWiFi services connect with PLAINTEXT
      listeners:
        client:
          protocol: PLAINTEXT
        controller:
          protocol: PLAINTEXT
        interbroker:
          protocol: PLAINTEXT
      volumePermissions:
        image:
          repository: bitnamilegacy/os-shell
      autoDiscovery:
        volumePermissions:
          image:
            repository: bitnamilegacy/kubectl
      metrics:
        jmx:
          image:
            repository: bitnamilegacy/jmx-exporter
      resources:
        limits:
          memory: 4Gi
        requests:
          memory: 4Gi

    # ─── HAProxy (bitnami subchart) ──────────────────────────────
    haproxy:
      enabled: true
      image:
        repository: bitnamilegacy/haproxy
      fullnameOverride: proxy
      replicaCount: 1
      service:
        type: LoadBalancer
        annotations:
          metallb.universe.tf/loadBalancerIPs: "10.0.50.200"
          metallb.universe.tf/allow-shared-ip: openwifi

    # ─── cert-manager REST API certs ─────────────────────────────
    restapiCerts:
      enabled: true
      clusterDomain: cluster.local
      services:
        - owgw
        - owsec
        - owfms
        - owprov
        - owanalytics
        - owsub

    # ─── OpenWiFi Gateway ────────────────────────────────────────
    owgw:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owgw"
        openwifi.system.uri.private: "http://owgw-owgw:17002"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── OpenWiFi Security ───────────────────────────────────────
    owsec:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owsec"
        openwifi.system.uri.private: "http://owsec-owsec:17001"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── OpenWiFi Firmware ───────────────────────────────────────
    owfms:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owfms"
        openwifi.system.uri.private: "http://owfms-owfms:17004"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── OpenWiFi Provisioning ───────────────────────────────────
    owprov:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owprov"
        openwifi.system.uri.private: "http://owprov-owprov:17005"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── OpenWiFi Subscription ───────────────────────────────────
    owsub:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owsub"
        openwifi.system.uri.private: "http://owsub-owsub:17006"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── OpenWiFi Analytics ──────────────────────────────────────
    owanalytics:
      configProperties:
        openwifi.kafka.enable: "true"
        openwifi.kafka.brokerlist: "kafka:9092"
        openwifi.security.restapi.disable: "true"
        openwifi.system.uri.public: "https://openwifi.wilsonfi.dev/owanalytics"
        openwifi.system.uri.private: "http://owanalytics-owanalytics:17009"
        openwifi.system.uri.ui: "https://openwifi.wilsonfi.dev"

    # ─── Web UIs ─────────────────────────────────────────────────
    owgwui:
      fullnameOverride: owgwui
      public_env_variables:
        REACT_APP_UCENTRALSEC_URL: "https://openwifi.wilsonfi.dev/owsec"

    owprovui:
      fullnameOverride: owprovui
      public_env_variables:
        REACT_APP_UCENTRALSEC_URL: "https://openwifi.wilsonfi.dev/owsec"

    # ─── Disable optional features ───────────────────────────────
    owls:
      enabled: false
    owlsui:
      enabled: false
    clustersysteminfo:
      enabled: false
